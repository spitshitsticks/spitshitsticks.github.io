---
layout: post
title:  "Что такое аналитические БД и зачем они нужны?"
author: "Evgeniy Petrov"
tags: ["аналитика", "clickhouse"]
---

Было обычное Барселонское утро

> У Сотрудника1 просели пуши последние 3 месяца чет, хотя объем трафика не падает

Сообщение было подкреплено скриншотом, где было видно, что действительно падают доходы при сохранном количестве подписок.

Я не обрадовался этому сообщению, потому что хорошо знал, что данные по рассылкам хранятся в очень неоперабельном виде, и искать в них что-то крайне затруднительно.

Процесс дата-майнинга, в общем случае заключается в том, что мы строим какие-то гипотезы на основании знаний, которыми мы обладаем и затем проверяем верность этих гипотез. Для успешной проверки гипотез вам необходима аналитическая база данных. Является ли ваш mysql, postgres, mongodb аналитической БД? Скорее всего нет и вот почему.

## Производительность

Когда вы работаете с данными, вы выдвигаете десятки гипотез, если на проверку одной у вас будет уходить неделя, то вы через неделю просто забудете что делали и, я даю руку на отсечение, вы просто не будете этим заниматься. Аналитическая БД должна быть быстрой.

Например, я проверял гипотезу о том, что у разных сотрудников одни и т же пользователи, которым приходят одни и те же сообщения и в итоге они кликают только на одно. Но проблема  в том, что в данных нет никакого идентификатора, по которому можно было бы сказать, что 2 разных пользователя в базе данных - это на самом деле один пользователь. Мне потребовалось сделать некое подобие fingerprint из тех данных, которые есть в наличии (хеш от (локация + ISP + таймзона + язык браузера + др данные)), после чего получилось исключить из анализа пользователей с одинаковым fingerprint и убедиться, что на оставшихся пользователях проблема все еще проявляется и таким образом исключить гипотезу.

По сути проверка гипотезы свелась к добавлению одной колонки и JOIN в запрос:
```sql
ALTER TABLE push ADD COLUMN _fingerprint String MATERIALIZED MD5(<fingerprint fields, …>);
```

```sql
SELECT
    <dimensions>,
    <measures>
FROM push
INNER JOIN (
    SELECT _fingerprint
    FROM push
    WHERE type = 'subscription'
    GROUP BY ALL
    HAVING count() = 1
) AS _ ON _._fingerprint = push._fingerprint
WHERE <filters>
GROUP BY ALL
```

При условии что у вас несколько десятков миллионов подписок, эти запросы в mysql выполнялись бы вечность. Правильная аналитическая БД делает это за минуты или секунды.

## Средства визуализации

У вас должна быть возможность строить различные графики, хитмапы, гистограмы и пр. Вы должны визуально видеть свои данные. Посмотрите на пример. Видите ли вы аномалию, глядя чисто на цифры? А если теперь посмотреть на график (нужно повернуть голову вправо)?

```
┌─────foo─┬─bar─────────────────────────────────────────────────────┐
│  983.28 │ █████████████████████████████████████████████████████▋  │
│  984.28 │ █████████████████████████████████████████████████████▋  │
│ 1007.52 │ ██████████████████████████████████████████████████████▉ │
│  975.65 │ █████████████████████████████████████████████████████▏  │
│ 1000.02 │ ██████████████████████████████████████████████████████▌ │
│  967.31 │ ████████████████████████████████████████████████████▊   │
│  991.69 │ ██████████████████████████████████████████████████████  │
│  995.58 │ ██████████████████████████████████████████████████████▎ │
│  977.31 │ █████████████████████████████████████████████████████▎  │
│ 1009.19 │ ███████████████████████████████████████████████████████ │
│  990.18 │ ██████████████████████████████████████████████████████  │
│   970.7 │ ████████████████████████████████████████████████████▉   │
│  978.66 │ █████████████████████████████████████████████████████▍  │
│  985.94 │ █████████████████████████████████████████████████████▊  │
│   997.7 │ ██████████████████████████████████████████████████████▍ │
│  996.91 │ ██████████████████████████████████████████████████████▍ │
│  927.22 │ ██████████████████████████████████████████████████▌     │
│  934.03 │ ██████████████████████████████████████████████████▉     │
│  937.95 │ ███████████████████████████████████████████████████▏    │
│  937.63 │ ███████████████████████████████████████████████████▏    │
└─────────┴─────────────────────────────────────────────────────────┘
```

Задача визуализации как правило - это не задача базы данных, для этого есть BI инструменты, но аналитическая БД должна давать возможность к ней вообще подключиться.

## Простое подключение внешних данных

Хорошо, если у вас в базе уже есть все данные, а если чего-то не хватает? Например у вас есть идентификатор кампании, но вы хотите знать источник трафика этой кампании, который есть только в какой-то админке в CSV формате. Или вам нужны курсы валют, которые доступны по API. Или у вас есть IP, а вам нужно получить по этому IP страну - если вы делаете глубокий анализ данных, то такие задачи должны решаться 10-20 строками кода на вашем любимом ЯП.

```sql
CREATE TABLE monobank_currency_eur
(
    `date` DateTime,
    `buying` Decimal(18, 4),
    `selling` Decimal(18, 4)
)
ENGINE = URL('https://kurstoday.com.ua/api/chart?exchanger_id=50&currency=EUR&from=2022-01&to=2024-12', 'JSON')
```

```sql
SELECT *
FROM monobank_currency_eur
ORDER BY date DESC
LIMIT 10
┌────────────────date─┬─buying─┬─selling─┐
│ 2024-05-11 00:00:00 │  42.45 │   43.09 │
│ 2024-05-10 00:00:00 │  42.45 │   43.15 │
│ 2024-05-09 00:00:00 │  42.29 │   42.91 │
│ 2024-05-08 00:00:00 │   42.1 │   42.71 │
│ 2024-05-07 00:00:00 │  42.18 │   42.71 │
│ 2024-05-06 00:00:00 │  42.22 │   42.89 │
│ 2024-05-05 00:00:00 │   42.3 │    42.9 │
│ 2024-05-04 00:00:00 │   42.3 │    42.9 │
│ 2024-05-03 00:00:00 │   42.3 │    42.9 │
│ 2024-05-02 00:00:00 │  42.25 │   42.73 │
└─────────────────────┴────────┴─────────┘
```

## Удобство работы

Я долгое время любил Elasticsearch, потому что быстрый. Но он абсолютно не годен для анализа данных, потому что не поддерживает SQL (на самом деле уже какой-то поддерживает, но сори, поезд уехал). Писать запросы на JSON супер неудобно. По этой же причине MongoDB абсолютно негодна для аналитики.